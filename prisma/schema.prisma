// EstimPro Database Schema
// Multi-tenant SaaS for auto body shops
// Provider: SQLite (dev) / PostgreSQL (prod)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String   // Nom de l'atelier
  slug      String   @unique // URL-friendly identifier
  address   String?
  phone     String?
  email     String?
  logoUrl   String?
  taxConfig String   @default("{}") // JSON: {"tps": 5, "tvq": 9.975}
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  clients   Client[]
  estimates Estimate[]
  insurers  Insurer[]
  auditLogs AuditLog[]

  @@index([slug])
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email         String
  passwordHash  String
  firstName     String
  lastName      String
  role          String    @default("ESTIMATOR") // ADMIN, MANAGER, ESTIMATOR
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  estimates     Estimate[]
  negotiations  Negotiation[]
  auditLogs     AuditLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
}

// ============================================
// CLIENTS & VEHICLES
// ============================================

model Client {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  firstName  String
  lastName   String
  phone      String?
  email      String?
  address    String?
  city       String?
  postalCode String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  vehicles  Vehicle[]
  estimates Estimate[]

  @@index([tenantId])
  @@index([tenantId, lastName])
  @@index([tenantId, phone])
}

model Vehicle {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  make      String   // Marque
  model     String   // Modèle
  year      Int
  vin       String?  // VIN
  plate     String?  // Immatriculation
  color     String?
  mileage   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  estimates Estimate[]

  @@index([clientId])
  @@index([plate])
  @@index([vin])
}

// ============================================
// ESTIMATES & LINE ITEMS
// ============================================

model Estimate {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  number       String   // Numéro de devis (séquentiel par tenant)
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id])
  vehicleId    String
  vehicle      Vehicle  @relation(fields: [vehicleId], references: [id])
  createdById  String
  createdBy    User     @relation(fields: [createdById], references: [id])
  status       String   @default("DRAFT") // DRAFT, SUBMITTED, NEGOTIATION, APPROVED, SIGNED, IN_REPAIR, READY, DELIVERED, CLOSED, LOST
  damageType   String?  // Type de dommage (collision, vandalisme, etc.)
  description  String?  // Description des dommages
  subtotal     Float    @default(0)
  taxTps       Float    @default(0)
  taxTvq       Float    @default(0)
  total        Float    @default(0)
  agreedPrice  Float?   // Prix convenu (locked)
  agreedAt     DateTime? // Date accord prix
  isLocked     Boolean  @default(false) // Verrouillé après approved
  timeSpentMin Int      @default(0) // Temps passé en minutes
  lossReason   String?  // Raison de perte si LOST
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lineItems    LineItem[]
  claim        Claim?
  negotiations Negotiation[]
  signatures   Signature[]

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdById])
  @@index([clientId])
  @@index([vehicleId])
  @@index([createdAt])
}

model LineItem {
  id          String   @id @default(cuid())
  estimateId  String
  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  type        String   // LABOR, PART, PAINT, MISC
  description String
  quantity    Float
  unitPrice   Float
  subtotal    Float    // quantity * unitPrice
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([estimateId])
}

// ============================================
// INSURANCE & CLAIMS
// ============================================

model Insurer {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  code      String?  // Code court (ex: INT pour Intact)
  phone     String?
  email     String?
  address   String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  claims Claim[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Claim {
  id            String   @id @default(cuid())
  estimateId    String   @unique
  estimate      Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  insurerId     String
  insurer       Insurer  @relation(fields: [insurerId], references: [id])
  claimNumber   String   // Numéro de réclamation
  adjusterName  String?  // Nom de l'expert
  adjusterPhone String?
  adjusterEmail String?
  deductible    Float?   // Franchise
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([insurerId])
  @@index([claimNumber])
}

model Negotiation {
  id          String   @id @default(cuid())
  estimateId  String
  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  notes       String   // Notes de négociation
  amount      Float?   // Montant proposé/contre-proposé
  createdAt   DateTime @default(now())

  @@index([estimateId])
  @@index([createdAt])
}

// ============================================
// SIGNATURES
// ============================================

model Signature {
  id         String   @id @default(cuid())
  estimateId String
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  type       String   // AUTHORIZATION, DELIVERY, ESTIMATE
  signerName String   // Nom du signataire
  imageUrl   String   // URL image signature (Blob Storage)
  signedAt   DateTime @default(now())

  @@index([estimateId])
  @@index([type])
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String   // CREATE, UPDATE, DELETE, LOGIN, STATUS_CHANGE, etc.
  entityType String   // Estimate, Client, etc.
  entityId   String?
  details    String?  // JSON details
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, action])
  @@index([tenantId, entityType, entityId])
  @@index([createdAt])
}
