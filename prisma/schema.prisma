// Prisma Schema pour Estimateur Carrosserie
// Stack: PostgreSQL with multi-tenant support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===== TENANTS & AUTH =====

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]
  clients    Client[]
  assurances Assurance[]

  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(ESTIMATEUR)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  devis    Devis[]
  relances Relance[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

enum Role {
  ADMIN
  MANAGER
  ESTIMATEUR
}

// ===== CLIENTS & VEHICLES =====

model Client {
  id         String   @id @default(uuid())
  firstName  String
  lastName   String
  email      String?
  phone      String
  address    String?
  city       String?
  postalCode String?
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  vehicles Vehicle[]
  devis    Devis[]

  @@index([tenantId])
  @@index([lastName, firstName])
  @@index([phone])
  @@map("clients")
}

model Vehicle {
  id           String   @id @default(uuid())
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  make         String
  model        String
  year         Int
  vin          String?
  licensePlate String?
  color        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  devis Devis[]

  @@index([clientId])
  @@index([licensePlate])
  @@index([vin])
  @@map("vehicles")
}

// ===== DEVIS =====

model Devis {
  id           String      @id @default(uuid())
  devisNumber  String      @unique @default(uuid()) // Human-readable, generated
  clientId     String
  client       Client      @relation(fields: [clientId], references: [id], onDelete: Restrict)
  vehicleId    String
  vehicle      Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  estimateurId String
  estimateur   User        @relation(fields: [estimateurId], references: [id], onDelete: Restrict)
  status       DevisStatus @default(BROUILLON)
  totalHT      Decimal     @default(0) @db.Decimal(10, 2)
  totalTPS     Decimal     @default(0) @db.Decimal(10, 2)
  totalTVQ     Decimal     @default(0) @db.Decimal(10, 2)
  totalTTC     Decimal     @default(0) @db.Decimal(10, 2)
  notes        String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  items       DevisItem[]
  reclamation Reclamation?
  relances    Relance[]

  @@index([clientId])
  @@index([estimateurId])
  @@index([status])
  @@index([createdAt])
  @@map("devis")
}

enum DevisStatus {
  BROUILLON
  ENVOYE
  EN_NEGOCIATION
  ACCEPTE
  REFUSE
  EN_REPARATION
  TERMINE
}

model DevisItem {
  id          String        @id @default(uuid())
  devisId     String
  devis       Devis         @relation(fields: [devisId], references: [id], onDelete: Cascade)
  description String
  type        DevisItemType
  quantity    Decimal       @db.Decimal(10, 2)
  unitPrice   Decimal       @db.Decimal(10, 2)
  total       Decimal       @db.Decimal(10, 2)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([devisId])
  @@map("devis_items")
}

enum DevisItemType {
  PIECE
  MAIN_OEUVRE
  PEINTURE
  AUTRE
}

// ===== ASSURANCES =====

model Assurance {
  id           String   @id @default(uuid())
  name         String
  contactName  String?
  contactEmail String?
  contactPhone String?
  notes        String?  @db.Text
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reclamations Reclamation[]

  @@index([tenantId])
  @@index([name])
  @@map("assurances")
}

model Reclamation {
  id          String             @id @default(uuid())
  devisId     String             @unique
  devis       Devis              @relation(fields: [devisId], references: [id], onDelete: Cascade)
  assuranceId String
  assurance   Assurance          @relation(fields: [assuranceId], references: [id], onDelete: Restrict)
  claimNumber String?
  agreedPrice Decimal?           @db.Decimal(10, 2)
  status      ReclamationStatus  @default(SOUMISE)
  notes       String?            @db.Text
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([assuranceId])
  @@index([status])
  @@map("reclamations")
}

enum ReclamationStatus {
  SOUMISE
  EN_ATTENTE
  APPROUVEE
  REFUSEE
  NEGOCIATION
}

// ===== RELANCES =====

model Relance {
  id           String      @id @default(uuid())
  devisId      String
  devis        Devis       @relation(fields: [devisId], references: [id], onDelete: Cascade)
  type         RelanceType
  notes        String      @db.Text
  outcome      String?
  nextFollowUp DateTime?
  createdById  String
  createdBy    User        @relation(fields: [createdById], references: [id], onDelete: Restrict)
  createdAt    DateTime    @default(now())

  @@index([devisId])
  @@index([createdById])
  @@index([nextFollowUp])
  @@map("relances")
}

enum RelanceType {
  APPEL
  EMAIL
  SMS
  VISITE
}
